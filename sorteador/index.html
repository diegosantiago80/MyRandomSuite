<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Media Studio | Sorteador Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #020617; 
            user-select: none;
            overflow-x: hidden;
        }

        .win-gradient { background: linear-gradient(135deg, #2e1065 0%, #0f172a 100%); }
        .podium-card { background: linear-gradient(135deg, #451a03 0%, #0f172a 100%); border: 1px solid #78350f; }
        
        /* Zona de seguridad para capturas m칩viles */
        .capture-safe-zone {
            padding: 30px 20px !important; 
            overflow: visible !important;
            min-width: 320px;
        }

        .safe-text { 
            line-height: 1.4; 
            word-break: break-word;
            display: block;
        }

        /* Animaci칩n suave para la aparici칩n de ganadores */
        .winner-entry {
            animation: slideUp 0.4s ease forwards;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Ocultar scrollbar en textarea */
        textarea::-webkit-scrollbar { width: 4px; }
        textarea::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-200 min-h-screen flex items-center justify-center p-4">

    <div class="max-w-xl w-full bg-slate-900/40 border border-slate-800/50 p-6 md:p-10 rounded-[2.5rem] shadow-2xl backdrop-blur-xl my-8">
        
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-black tracking-tight bg-gradient-to-r from-cyan-400 via-violet-400 to-fuchsia-400 bg-clip-text text-transparent italic">
                Random Media Studio
            </h1>
            <div class="flex items-center justify-center gap-2 mt-3">
                <span class="h-[1px] w-8 bg-slate-800"></span>
                <p class="text-slate-500 font-bold uppercase text-[9px] tracking-[0.4em]">Sorteador Pro v2.0</p>
                <span class="h-[1px] w-8 bg-slate-800"></span>
            </div>
        </header>

        <div class="space-y-6" id="setupArea">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="bg-slate-950/50 p-4 rounded-2xl border border-slate-800">
                    <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest block mb-2">Cant. Ganadores</label>
                    <input type="number" id="totalWinners" min="1" max="50" value="1" 
                        class="w-full bg-transparent text-2xl text-cyan-400 font-black focus:outline-none">
                </div>
                
                <div class="flex items-center justify-between bg-slate-950/50 p-4 rounded-2xl border border-slate-800">
                    <label for="cleanDuplicates" class="text-[10px] text-slate-500 uppercase font-black tracking-widest cursor-pointer">Limpiar Duplicados</label>
                    <input type="checkbox" id="cleanDuplicates" onchange="updateCount()" class="w-5 h-5 accent-cyan-500 rounded-lg cursor-pointer">
                </div>
            </div>

            <div class="relative">
                <textarea id="participants" oninput="updateCount()"
                    class="w-full h-48 p-5 bg-slate-950/80 border border-slate-800 rounded-[1.5rem] outline-none resize-none text-slate-300 text-sm focus:border-cyan-500/50 transition-all shadow-inner"
                    placeholder="Escribe o pega los nombres (uno por l칤nea)..."></textarea>
                <div id="countDisplay" class="absolute bottom-4 right-4 text-[9px] bg-cyan-500/10 text-cyan-400 px-3 py-1 rounded-full font-black uppercase tracking-tighter">
                    0 Participantes
                </div>
            </div>
        </div>

        <button onclick="startRaffle()" id="drawButton"
            class="w-full mt-8 py-5 bg-gradient-to-r from-cyan-600 to-violet-600 hover:from-cyan-500 hover:to-violet-500 text-white font-black rounded-2xl transition-all transform active:scale-95 uppercase tracking-[0.2em] text-xs shadow-lg shadow-cyan-900/20">
            Lanzar Sorteo
        </button>

        <div id="captureArea" class="hidden mt-8 p-1 bg-gradient-to-r from-cyan-500 via-violet-500 to-fuchsia-500 rounded-3xl shadow-2xl overflow-hidden">
            <div class="win-gradient rounded-[1.4rem] text-center capture-safe-zone">
                <h3 id="statusLabel" class="text-cyan-400 font-black uppercase tracking-[0.4em] text-[10px] mb-6 opacity-80">Sorteando...</h3>
                <div id="winnerName" class="text-3xl md:text-5xl font-black text-white mb-6 min-h-[1.2em] safe-text px-4"></div>
                <div class="flex items-center justify-center gap-3 opacity-30">
                    <div class="h-[1px] w-4 bg-white"></div>
                    <div class="text-[8px] text-white font-bold uppercase tracking-widest">Random Media Studio</div>
                    <div class="h-[1px] w-4 bg-white"></div>
                </div>
            </div>
        </div>

        <div id="finalCaptureArea" class="hidden mt-8 p-1 bg-gradient-to-r from-amber-500 via-yellow-400 to-orange-500 rounded-3xl shadow-2xl overflow-hidden">
            <div class="podium-card rounded-[1.4rem] text-center capture-safe-zone">
                <h3 class="text-amber-400 font-black uppercase tracking-[0.5em] text-[11px] mb-8 italic">游끥 Cuadro de Honor</h3>
                <div id="finalWinnersList" class="space-y-3 mb-8 px-2"></div>
                <div class="text-[8px] text-slate-500 font-bold uppercase tracking-[0.3em]">Certificado por Random Media Studio</div>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-6">
            <button id="downloadBtn" onclick="downloadResult()" 
                class="hidden py-4 bg-slate-800 hover:bg-slate-700 text-white rounded-xl text-[10px] font-black transition-all uppercase tracking-widest flex items-center justify-center gap-2">
                <span>游닌 Descargar PNG</span>
            </button>
            <button id="resetBtn" onclick="clearHistory()" 
                class="hidden py-4 border border-slate-800 hover:bg-red-950/20 hover:border-red-900 text-slate-500 hover:text-red-500 rounded-xl text-[10px] font-black transition-all uppercase tracking-widest">
                Reiniciar
            </button>
        </div>

    </div>

    <script>
        const drumRoll = new Audio('https://assets.mixkit.co/active_storage/sfx/2012/2012-preview.mp3');
        const winSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2004/2004-preview.mp3');
        
        function updateCount() {
            const text = document.getElementById('participants').value;
            let lines = text.split('\n').filter(p => p.trim() !== "");
            if (document.getElementById('cleanDuplicates').checked) lines = [...new Set(lines)];
            document.getElementById('countDisplay').innerText = `${lines.length} PARTICIPANTES`;
        }

        function startRaffle() {
            const total = parseInt(document.getElementById('totalWinners').value);
            const history = JSON.parse(localStorage.getItem('winnerHistory')) || [];
            
            if (history.length >= total) return;

            let participants = document.getElementById('participants').value.split('\n').filter(p => p.trim() !== "");
            if (document.getElementById('cleanDuplicates').checked) participants = [...new Set(participants)];
            
            const previousWinners = history.map(h => h.name);
            participants = participants.filter(p => !previousWinners.includes(p));

            if (participants.length < 1) return alert("춰No hay m치s participantes disponibles!");

            const drawButton = document.getElementById('drawButton');
            drawButton.disabled = true;
            drawButton.classList.add('opacity-50');

            const puestoActual = history.length + 1;
            document.getElementById('statusLabel').innerText = `Sorteando Ganador #${puestoActual}...`;
            document.getElementById('captureArea').classList.remove('hidden');
            document.getElementById('finalCaptureArea').classList.add('hidden');
            
            drumRoll.play();
            let counter = 0;
            const interval = setInterval(() => {
                document.getElementById('winnerName').innerText = participants[Math.floor(Math.random() * participants.length)];
                if (++counter > 25) {
                    clearInterval(interval);
                    finalizeWinner(participants, puestoActual, total);
                }
            }, 80);
        }

        function finalizeWinner(list, puesto, total) {
            drumRoll.pause(); drumRoll.currentTime = 0;
            winSound.play();
            
            const winner = list[Math.floor(Math.random() * list.length)];
            document.getElementById('winnerName').innerText = winner;

            let history = JSON.parse(localStorage.getItem('winnerHistory')) || [];
            history.push({ name: winner, puesto: puesto });
            localStorage.setItem('winnerHistory', JSON.stringify(history));

            launchConfetti();
            
            document.getElementById('drawButton').disabled = false;
            document.getElementById('drawButton').classList.remove('opacity-50');
            document.getElementById('downloadBtn').classList.remove('hidden');
            document.getElementById('resetBtn').classList.remove('hidden');

            if (history.length >= total) {
                document.getElementById('drawButton').innerText = "SORTEO COMPLETADO";
                document.getElementById('drawButton').classList.replace('from-cyan-600', 'from-slate-700');
                setTimeout(showFinalPodium, 1000);
            }
        }

        function showFinalPodium() {
            const history = JSON.parse(localStorage.getItem('winnerHistory')) || [];
            const listContainer = document.getElementById('finalWinnersList');
            
            listContainer.innerHTML = history.map(h => `
                <div class="flex items-center justify-between bg-white/5 p-4 rounded-2xl border border-white/10 shadow-lg winner-entry">
                    <span class="text-amber-400 font-black text-lg w-10 text-left">#${h.puesto}</span>
                    <span class="text-white font-bold text-base md:text-lg flex-1 text-right truncate pl-4">${h.name}</span>
                </div>
            `).join('');

            document.getElementById('captureArea').classList.add('hidden');
            document.getElementById('finalCaptureArea').classList.remove('hidden');
        }

        function launchConfetti() {
            const end = Date.now() + 2 * 1000;
            const colors = ['#22d3ee', '#8b5cf6', '#ffffff'];

            (function frame() {
                confetti({ particleCount: 3, angle: 60, spread: 55, origin: { x: 0 }, colors: colors });
                confetti({ particleCount: 3, angle: 120, spread: 55, origin: { x: 1 }, colors: colors });
                if (Date.now() < end) requestAnimationFrame(frame);
            }());
        }

        function clearHistory() {
            localStorage.removeItem('winnerHistory');
            location.reload();
        }

        async function downloadResult() {
            const total = parseInt(document.getElementById('totalWinners').value);
            const history = JSON.parse(localStorage.getItem('winnerHistory')) || [];
            const isFinal = history.length >= total;
            const elementId = isFinal ? 'finalCaptureArea' : 'captureArea';
            const element = document.getElementById(elementId);
            
            const options = {
                backgroundColor: '#020617',
                scale: 2,
                useCORS: true,
                logging: false,
                borderRadius: 20
            };
            
            const canvas = await html2canvas(element, options);
            const link = document.createElement('a');
            link.download = `Sorteo-${isFinal ? 'Final' : 'Parcial'}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        }
    </script>
</body>
</html>